# jdm 11/8/2014
## EA6Prowler.org
#
# keep global stuff outside of server blocks to avoid repetition.
#
index index.php;

root /home/prowler/public;
#
# return 301 if hitting www and redirect to https
#
server {
  listen 80; 
  server_name ea6bprowler.org www.ea6bprowler.org;
  return 301 https://ea6b.techsolx.com/$request_uri;
}
#
# now go on to ssl based site
#
server {
  listen  443;
  server_name ea6b.techsolx.com;
  ssl on;
	ssl_certificate /etc/ssl/localcerts/selfkey.pem;
	ssl_certificate_key /etc/ssl/localcerts/selfkey.key;
	ssl_session_cache shared:SSL:10m;
	ssl_session_timeout 5m;
	ssl_protocols TLSv1.1 TLSv1.2;
	ssl_ciphers HIGH:!aNULL:!MD5:!kEDH:!SSLv3;
#  ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
#  ssl_ciphers HIGH:!aNULL:!MD5:!kEDH:!ADH:!EXPORT56:!kEDH:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
#
# log files go here
#

  access_log /home/prowler/log/access.log;
  error_log  /home/prowler/log/error.log;
#

# Lets mash things up a bit
  gzip on;

  gzip_types text/css text/x-component application/x-javascript 
    application/javascript text/javascript text/x-js text/richtext 
    image/svg+xml text/plain text/xsd text/xsl text/xml image/x-icon;

# First attempt to serve request as file, then
# as directory, then fall back to displaying a 404.
# then clean up requests later to lower server load
# working to fix permalink error by dropping 404 and
# allowing wordpress to handle that part
#
  location / {
    try_files $uri $uri/ /index.php?$args;
  }
#
# don't allow access to .files
#
  location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
  }
#
# don't log access to favicon
#
  location = /favicon.ico {
    log_not_found off;
    access_log off;
  }
#
# what to do with robots
#
  location = /robots.txt {
    allow all;
    log_not_found off;
    access_log off;
  }
#
# what to do with php requests 
#
  location ~ \.php$ {
    try_files $uri =404;
    fastcgi_pass unix:/var/run/php5-fpm.sock;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
  }
}
